const path = require('path');
const fs = require('fs/promises');
const pick = require('just-pick');
const rimraf = require('rimraf');
const { getRepoRootPath, getKitDirs } = require('../../../scripts/kits-utils');

const KIT_PAGE_RELATIVE_LAYOUT_PATH = '../../layouts/KitLayout.astro';

function convertToFrontmatter(obj) {
  return Object.entries(obj)
    .map(([key, value]) => `${key}: ${obj[key]}`)
    .join('\n');
}

function formatMarkdownFile(markdown, frontmatter) {
  return `---
# generated by scripts/kitgen at ${new Date().toISOString()}
# edit KIT_PAGE_RELATIVE_LAYOUT_PATH in scripts/kitgen to change layout
layout: ${KIT_PAGE_RELATIVE_LAYOUT_PATH}
${frontmatter}
---

${markdown}`;
}

///////////////////////////////////////////////////////////////////////////////
// SCRIPT MAIN
////////////////////////////////////////////////////////////////////////////////

(async () => {
  const repoPath = getRepoRootPath();
  const kitPagesPath = path.join(repoPath, 'packages/website/src/pages/kits');

  try {
    const handle = await fs.opendir(kitPagesPath);
    console.info('kitgen: deleting existing kit pages');
    rimraf(`${kitPagesPath}/*.md,${kitPagesPath}/*.mdx`, async (err) => {
      if (err) {
        console.error(err);
      }
      await handle.close();
    });
  } catch (err) {
    if (err && err.code === 'ENOENT') {
      console.info('kitgen: creating kit pages directory');
      await fs.mkdir(kitPagesPath);
    }
  }

  const kitDirs = await getKitDirs();

  console.info('kitgen: generating kit pages');
  for (const dir of kitDirs) {
    const kitPath = path.join(repoPath, 'starters', dir);

    let infoFile = 'package.json';
    if (dir.startsWith('deno-')) {
      // For Deno, we don't have package.json
      infoFile = 'deno.json';
    }

    try {
      const readme = await fs.readFile(
        path.join(kitPath, 'README.md'),
        'utf-8'
      );
      const json = await fs.readFile(path.join(kitPath, infoFile), 'utf-8');
      const data = JSON.parse(json);

      const kitData = {
        ...pick(data, [
          'name',
          'version',
          'description',
          'keywords',
          'hasShowcase',
        ]),
        readmePath: path.join(kitPath, 'README.md'),
        starterPath: `/starters/${dir}`,
      };

      const frontmatter = convertToFrontmatter(kitData);
      const formattedMarkdown = formatMarkdownFile(readme, frontmatter);

      const kitPagePath = path.join(
        repoPath,
        'packages/website/src/pages/kits',
        `${data.name}.mdx`
      );

      await fs.writeFile(kitPagePath, formattedMarkdown, 'utf-8');
    } catch (err) {
      console.error(
        `KITGEN: failed to write kit page for ${dir}: ${err.message}`
      );
    }
  }
})();
